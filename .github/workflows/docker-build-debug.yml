name: Docker Build Debug

on:
  workflow_dispatch:

env:
  REGISTRY_GHCR: ghcr.io

jobs:
  debug-build:
    name: Debug Docker Build
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Show file structure
        run: |
          echo "=== Root directory ==="
          ls -la
          echo ""
          echo "=== Docker directory ==="
          ls -la docker/
          echo ""
          echo "=== Web directory ==="
          ls -la web/
          echo ""
          echo "=== Nginx directory ==="
          ls -la nginx/
          echo ""
          echo "=== Go files ==="
          ls -la *.go 2>/dev/null || echo "No Go files in root"
          echo ""
          echo "=== go.mod content ==="
          cat go.mod
          echo ""
          echo "=== web/package.json content ==="
          cat web/package.json

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Try building backend (without push)
        run: |
          echo "=== Building backend Docker image ==="
          docker buildx build \
            --file ./docker/Dockerfile.backend \
            --platform linux/amd64 \
            --progress=plain \
            --no-cache \
            . 2>&1 | tee backend-build.log || true

          echo ""
          echo "=== Backend build exit code: $? ==="

      - name: Try building frontend (without push)
        run: |
          echo "=== Building frontend Docker image ==="
          docker buildx build \
            --file ./docker/Dockerfile.frontend \
            --platform linux/amd64 \
            --progress=plain \
            --no-cache \
            . 2>&1 | tee frontend-build.log

          EXIT_CODE=$?
          echo ""
          echo "=== Frontend build exit code: $EXIT_CODE ==="

          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "=== Last 100 lines of frontend build log ==="
            tail -100 frontend-build.log
          fi

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            backend-build.log
            frontend-build.log